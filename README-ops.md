# DNS platform operations guide

This document describes how to provision and operate the DNS platform with the
Ansible playbooks that live in this repository.

## Prerequisites

* **Python**: 3.11 or newer.
* **Ansible**: 9.x (installed via `pip install ansible`).
* **Ansible-lint**: 24.x (installed via `pip install ansible-lint`).
* Optional tooling can be installed with `pip install -r requirements-ansible.txt`
  if you prefer to pin dependency versions.

Before running the playbooks ensure that the `group_vars/all/vault.yml` file
exists and is encrypted with `ansible-vault`. A template can be generated by
copying `group_vars/all/vault.yml.example` and then running:

```bash
cp group_vars/all/vault.yml.example group_vars/all/vault.yml
ansible-vault encrypt group_vars/all/vault.yml
```

You will be prompted for the vault password when running the playbooks.

## Repository layout

```
playbooks/site.yml           # Main orchestration entrypoint
inventories/                 # Environment specific inventories
  prod/                      # Production hosts and group overrides
  local/                     # Local development overrides
infra/roles/                 # All Ansible roles used by the playbooks
group_vars/                  # Shared variables across inventories
ansible.cfg                  # Default Ansible configuration
Makefile                     # Helper targets for automation
```

## Deploying to production

Use the `deploy` make target (or call `ansible-playbook` directly) to apply the
production configuration:

```bash
make deploy
# which runs
ansible-playbook -i inventories/prod playbooks/site.yml
```

The playbook executes infrastructure roles first (`infra/postgres`,
`infra/redis`) and then deploys each Go service (`services/auth-svc`,
`services/sites-svc`, `services/jobs-svc`, `services/api-gw`,
`services/dns-agent`) with the GeoIP assets provisioned beforehand.

### Local orchestration

A dedicated inventory is provided for local testing. By default it skips actual
changes so that CI jobs and local dry-runs remain safe:

```bash
ansible-playbook -i inventories/local playbooks/site.yml \
  -e orchestration_skip_deploy=true
```

To exercise the roles against a local sandbox set
`orchestration_skip_deploy=false` and ensure the necessary services (PostgreSQL,
Redis, etc.) are available on localhost.

### CI pipeline

The `.github/workflows/ansible.yml` workflow automatically lints the playbook
and performs a dry-run against the local inventory on every push and pull
request that touches infrastructure code. This mirrors the `make ansible-check`
and `make ansible-lint` targets.

## Environment variables and secrets

Shared configuration is described in `group_vars/all.yml`. It contains:

* Network addressing for databases, caches, and HTTP entrypoints.
* Vault-backed secrets (`vault_postgres_password`, `vault_redis_password`,
  `vault_jwt_signing_key`, `vault_jobs_maxmind_license_key`).
* Performance tuning knobs consumed across roles.
* Default telemetry endpoints for the DNS agents.

All sensitive values must be stored in the encrypted
`group_vars/all/vault.yml` file. Environments can override any of the variables
by adding additional files under `inventories/<env>/group_vars/`.

## Rollback plan

1. Identify the last known good Git tag or commit for the infrastructure
   playbooks.
2. Re-run the deployment using that revision:
   ```bash
   git checkout <stable-ref>
   ansible-playbook -i inventories/prod playbooks/site.yml
   ```
3. If the rollback requires configuration changes (for example removing a
   misbehaving service release), adjust the corresponding group vars and re-run
   `make deploy`.
4. After recovering the environment, return to the latest branch and create a
   follow-up fix that addresses the root cause before attempting another
   deployment.

Always verify application health (API gateway, jobs processors, DNS agents) and
monitor telemetry dashboards after executing the rollback.
