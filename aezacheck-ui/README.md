# AezaCheck UI

Этот пакет содержит фронтенд-оболочку операторской консоли AezaCheck. Приложение
написано на React + TypeScript (Vite) и отображает телеметрию в реальном времени
из control plane заданий.

## Поток телеметрии карты

Экран карты подписывается на SSE-эндпоинт jobs-сервиса `/v1/map/events`.
Создавая `EventSource`, добавьте параметр `access_token` в query — браузеры не
передают заголовки `Authorization` для SSE-подключений. Пример:

```ts
const source = new EventSource(`${apiBase}/v1/map/events?access_token=${token}`);
```

Поток отправляет keepalive-комментарии каждые 15 секунд. Отдельные события — это
JSON-пакеты со следующими типами:

| Тип             | Описание                                                                      |
| ----------------| ------------------------------------------------------------------------------ |
| `agent.online`  | Хартбит/регистрация агента. `data.agent` содержит `id`, `ip`, `geo`.           |
| `check.start`   | Выдан новый чек. `data.source/target.geo` содержат геолокацию.                 |
| `check.result`  | Промежуточный результат со статусом (`ok`, `error`, `cancelled` и т.д.).       |
| `check.done`    | Финальное завершение. Включает `status` и исходную геолокацию источника.       |

SLA для UI — доставка события менее секунды от публикации и keepalive не реже
чем раз в 15 секунд.

## Локальная разработка

Установите зависимости и запустите dev-сервер:

```bash
npm install
npm run dev
```

### Конфигурация рантайма

Фронтенд читает следующие переменные окружения (все с префиксом `VITE_`). Создайте
`.env.local` или экспортируйте значения в shell:

| Переменная | Описание | Значение по умолчанию |
| --- | --- | --- |
| `VITE_API_BASE` | Базовый URL для API-запросов в production-сборке. | `/v1` |
| `VITE_API_PROXY_TARGET` | Целевой адрес для dev-прокси (`/api/*`). При установке dev-сервер пробрасывает запросы к бэкенду. | `http://localhost:8088` |
| `VITE_USE_PROXY` | Принудительное включение прокси `/api` даже без `VITE_API_PROXY_TARGET`. Установите `true`, если бэкенд на другом origin. | `false` |
| `VITE_API_TIMEOUT` | Таймаут запросов (мс) для типизированного API-клиента. | `15000` |
| `VITE_API_RETRY_LIMIT` | Количество автоматических ретраев для идемпотентных запросов. | `2` |
| `VITE_DEV_PORT` | Порт для `npm run dev`. | `5173` |

В режиме разработки UI обращается к `/api/*`; настройте прокси-цель, чтобы
пробрасывать запросы к вашему backend, или задайте `VITE_API_BASE` полным URL,
чтобы обойти прокси.

### Консоль управления агентами

Маршрут `/app/agents` открывает операционную панель агента:

- Виртуализованный список для большого числа агентов с поиском, фильтрацией по
  статусу и оптимистичными обновлениями.
- Доска статусов задач с агрегированным прогрессом по состояниям.
- Прокручиваемая история взаимодействий с постраничной догрузкой.
- Кнопки отмены запросов и уведомления об ошибках для наблюдаемости.

### Тестирование

Юнит-тесты запускаются через [Vitest](https://vitest.dev):

```bash
npm run test
```

End-to-end смоук-тесты используют [Playwright](https://playwright.dev). Они
поднимают dev-сервер автоматически и подменяют ответы backend-а:

```bash
npm run test:e2e
```

### Ручная проверка

1. Выполните `npm run dev` и откройте `http://localhost:5173/app/agents`.
2. Убедитесь, что список агентов постранично подгружает и виртуализует записи,
   пока фильтры продолжают работать.
3. Измените статус через выпадающий список и проверьте, что UI обновляется
   оптимистично.
4. Нажмите «Загрузить ещё» в панели истории и убедитесь, что записи добавляются
   без потери предыдущих.
