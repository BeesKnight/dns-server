# Публичный API Control Plane

Этот документ описывает контракт агент ↔ control plane, дополняет описание
OpenAPI в [`control-plane-openapi.yaml`](./control-plane-openapi.yaml) и фиксирует
SLA, лимиты запросов и ожидания по ретраям, согласованные с командой фронтенда
(договор зафиксирован в обзоре спринта 2024-07).

## Аутентификация
* Агенты получают токен аутентификации во время регистрации. Control plane
  возвращает кортеж `(agent_id, auth_token)`.
* Все последующие запросы должны включать:
  * `X-Agent-Id: <agent_id>`
  * `X-Agent-Token: <auth_token>`
* Срок действия токена совпадает со сроком жизни записи агента. Ответ
  `401/ERR_TOKEN_EXPIRED` требует повторной регистрации.

## Сводка эндпоинтов
| Endpoint | Method | Назначение |
| --- | --- | --- |
| `/register` | `POST` | Запуск новой или возвращающейся инсталляции агента. Идемпотентно для hostname. |
| `/heartbeat` | `POST` | Обновление дедлайна heartbeat-а агента. |
| `/claim` | `POST` | Запрос новой работы исходя из мощностей по каждому типу задач. |
| `/extend` | `POST` | Продление дедлайнов активных аренд. |
| `/report` | `POST` | Отправка отчётов о завершении/отмене с наблюдениями. |
| `/metrics` | `POST` | Приём внепроцессных метрик (агрегированные счётчики, датчики). |
| `/config` | `GET` | Получение последнего подписанного бандла конфигурации агента. |

Структуры полезных нагрузок, ответы и коды ошибок заданы в спецификации OpenAPI
и проиллюстрированы в разделе примеров.

## Таксономия ошибок
Каждый объект ошибки имеет вид:

```json
{
  "error": "ERR_CODE",
  "message": "Человекочитаемое описание",
  "retryable": true
}
```

Канонические коды:

* `ERR_VALIDATION` (400) — некорректный payload, отсутствуют обязательные поля.
* `ERR_UNAUTHORIZED` (401) — отсутствуют/некорректны заголовки аутентификации.
* `ERR_FORBIDDEN` (403) — агент заблокирован или отозван.
* `ERR_NOT_FOUND` (404) — неизвестный ресурс (например, идентификатор аренды).
* `ERR_CONFLICT` (409) — дублирующая регистрация или устаревшая ревизия.
* `ERR_RATE_LIMITED` (429) — превышена квота; включает заголовок `Retry-After`.
* `ERR_BACKEND` (500) — временный сбой backend-а (рекомендуется ретрай).
* `ERR_UNAVAILABLE` (503) — control plane перегружен, ответ содержит подсказку по повтору.

## Примеры
Примеры полезных нагрузок приведены прямо в спецификации OpenAPI. Для быстрого
доступа:

### Регистрация
```http
POST /register HTTP/1.1
Content-Type: application/json

{"hostname": "agent-01.example"}
```
Ответ:
```json
{
  "agent_id": 42,
  "lease_duration_ms": 60000,
  "heartbeat_timeout_ms": 45000,
  "auth_token": "eyJhbGciOi..."
}
```

### Запрос работы
```json
{
  "agent_id": 42,
  "capacities": {
    "dns": 4,
    "http": 2
  }
}
```

### Отправка метрик
```json
{
  "agent_id": 42,
  "timestamp": "2024-06-27T12:00:00Z",
  "counters": [
    {"name": "tasks_completed", "value": 128},
    {"name": "lease_extensions", "value": 32}
  ],
  "gauges": [
    {"name": "cpu_load", "value": 0.76, "unit": "fraction"}
  ]
}
```

## SLA и целевые показатели производительности
* **Доступность:** 99.5% аптайма в месяц для всех эндпоинтов control plane.
* **Задержка P50/P95:** `register` ≤ 200 мс / 500 мс, `heartbeat` ≤ 100 мс / 300 мс,
  `claim` ≤ 150 мс / 400 мс, `extend` ≤ 120 мс / 350 мс, `report` ≤ 200 мс / 500 мс.
* **Метрики/конфигурация:** ≤ 250 мс / 600 мс.
* **Хранение данных:** payload-ы задач и метрик сохраняются ≥ 30 дней.

## Ограничения скорости и квоты
* `register`: 1 запрос на агента каждые 10 минут (burst 1).
* `heartbeat`: по умолчанию 6 запросов в минуту с burst 3.
* `claim`: 12 запросов в минуту с burst 6.
* `extend`: 30 запросов в минуту с burst 10.
* `report`: 12 запросов в минуту с burst 6.
* `metrics`: 60 запросов в минуту с burst 10.
* `config`: 6 запросов в час с burst 2 (используйте `If-None-Match`).

При превышении лимита возвращается `429 ERR_RATE_LIMITED` с заголовком `Retry-After`.

## Рекомендации по политике ретраев
* Повторяйте запросы с экспоненциальным бэкоффом, начиная со 100 мс, с джиттером,
  соблюдая флаг `retryable` и заголовок `Retry-After`.
* Прекращайте ретраи после 5 последовательных ошибок для `register`. Остальные
  эндпоинты можно повторять бесконечно, соблюдая локальную конфигурацию бэкоффа
  агента.
* Тайм-ауты сети следует считать подходящими для повторов.

## Согласование с фронтендом
Команда фронтенда подтвердила готовность:
* Показывать свежесть heartbeat-а агента через поле `next_deadline_ms`.
* Отображать прогресс по аренде через `LeaseReport.observations`.
* Выводить сообщения о лимитах на основе канонических кодов ошибок выше.

Любые ломающие изменения в payload-ах требуют минимум два релиза на депрекацию
и координации через общий канал API-ревью.
