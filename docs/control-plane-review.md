# Обзор модуля Control Plane

## Область охвата
Этот обзор охватывает текущую реализацию в `src/control_plane/` и соседние
модули, которые её используют (`src/lease_extender.rs`, `src/workers/` и
инициализацию в `src/main.rs`). Цель — определить доменные сущности, которые
должны быть представлены во внешнем API control plane.

## Архитектура верхнего уровня
* `ControlPlaneClient<T>` инкапсулирует повторные RPC-вызовы к удалённому control
  plane, используя внедрённую реализацию `ControlPlaneTransport`.
* `HttpControlPlaneTransport` — конкретный транспорт поверх JSON/HTTP. Он
  управляет общим экземпляром `reqwest::Client`, определением базового URL и
  опциональными заголовками аутентификации.
* `AgentRuntime` (внутренний для клиента) отслеживает состояние жизненного цикла,
  счётчики ретраев, heartbeat-и и дедлайны аренды, чтобы управлять
  экспоненциальным бэкоффом и гарантировать соблюдение агентом контрактов
  control plane.
* Зависимые модули (`lease_extender`, рабочие процессы, диспетчер) опираются
  исключительно на типизированные структуры запросов/ответов, экспортируемые из
  этого модуля.

## Сущности для внешнего API
Следующие типы необходимо стабилизировать и раскрыть на публичной поверхности
API. Они напрямую соответствуют ресурсам control plane и после публикации должны
оставаться обратно совместимыми.

### Жизненный цикл агента
* `RegisterRequest` и `RegisterResponse` — рукопожатие регистрации. Ответ
  содержит авторитетный `agent_id`, длительность аренды, таймаут heartbeat-а и
  bearer-токен для последующих вызовов. Ошибки регистрации сейчас повторяются
  бесконечно с экспоненциальным бэкоффом.
* `HeartbeatRequest` и `HeartbeatResponse` — периодический сигнал живости,
  который продлевает дедлайн heartbeat-а, хранимый рантаймом агента.

### Процесс аренды задач
* Перечисление `TaskKind` — набор поддерживаемых категорий задач (`dns`, `http`,
  `tcp`, `ping`, `trace`). Используется как ключ в объявлении мощностей агента.
* Объединение `TaskSpec` и связанные спецификации (`TcpSpec`, `PingSpec`,
  `TraceSpec`) — структура исполняемых заданий, которые возвращает control
  plane. Агент ожидает, что JSON-дискриминатор `kind` соответствует вариантам
  `TaskKind`.
* `Lease` — оборачивает `TaskSpec` метаданными аренды (`lease_id`, `task_id`,
  `lease_until_ms`).
* `ClaimRequest` и `ClaimResponse` — пакетное согласование аренды. Рабочие
  процессы выбирают конкурентность на основании `capacities: HashMap<TaskKind,
  usize>`.
* `ExtendRequest` и `ExtendOutcome` — используются расширителем аренды для
  продления активных задач. Каждый результат возвращает новый дедлайн в
  миллисекундах.
* `ReportRequest`, `LeaseReport`, `Observation` и `ReportResponse` — отчётность
  о завершении задач со структурированной телеметрией.

### Обработка ошибок и ретраи
* `ControlPlaneError` инкапсулирует логические ошибки (например, незарегистрированный
  агент) и транспортные сбои. Временные ошибки задействуют `BackoffPolicy` в
  цикле ретраев.
* `TransportError` перечисляет ошибки HTTP-статусов, проблемы сериализации и
  backend-сбои, которые должны переводиться в задокументированные коды ошибок
  API.

### Сопутствующие модули
* Абстракция `LeaseExtendClient` и рантайм `lease_extender` зависят от типов
  `ExtendOutcome` и `Lease`, благодаря чему изменения контракта API сразу
  отражаются на служебной логике агента.
* Рабочие пути выполнения опираются на содержимое `TaskSpec` для организации
  протоколо-специфичных проверок, поэтому любое развитие контракта должно
  сохранять гарантии прямой и обратной совместимости по каждой категории задач.

## Выявленные пробелы во внешнем API
1. **Обмен метриками** — агент уже отправляет записи `Observation`, но нет
   явного API для потоковой передачи или запроса эксплуатационных метрик вне
   отчётов по задачам. Для дорожной карты требуется отдельная точка приёма
   метрик.
2. **Управление конфигурацией** — отсутствует механизм доставки динамической
   конфигурации агента (фича-флаги, лимиты, переопределения). API должен
   предоставлять подписанную точку получения конфигурации с контролем ревизий.
3. **Таксономия ошибок** — `TransportError::Backend` возвращает непрозрачные
   строки. Внешний API обязан задать канонические коды ошибок и соответствие
   HTTP-статусам для единообразной обработки на стороне клиента.

Эти пробелы легли в основу предложенных контрактов в
`docs/control-plane-api.md` и сопутствующей спецификации OpenAPI.
